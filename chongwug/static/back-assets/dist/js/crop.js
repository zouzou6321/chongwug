!function(i){i.crop=function(){function t(){var i=p.filter(":selected");return{minSize:i.data("size"),type:i.attr("value")}}function e(){var t={};return i.each(p,function(e,n){var a=i(n);t[a.attr("value")]={minSize:a.data("size"),text:a.text()}}),t}function n(t,e){var n=i("<img>");n.on("load",function(){e()}),n.attr("src",t)}function a(t,e,n){var a=e[0]/e[1];t.Jcrop({aspectRatio:a,minSize:e,setSelect:[0,0,e[0],e[1]]},function(){m=this}),i.isArray(n)&&m.setSelect(n)}function o(i){S.val(JSON.stringify(i))}function l(i){var t=previewSize[0]/i.w,e=previewSize[1]/i.h;h.css({width:Math.round(t*actualSize[0])+"px",height:Math.round(e*actualSize[1])+"px",marginLeft:"-"+Math.round(t*i.x)+"px",marginTop:"-"+Math.round(e*i.y)+"px"}),o(i)}function r(i){var t=g;for(var e in i)t=t.replace(new RegExp("{"+e+"}","gm"),i[e]);return t}function c(t){v=d.html('<img src="'+t.url+'">').find("img"),h=t.img||i(r({src:t.url,index:index})).appendTo(f).find("img"),t.img||h.data({width:t.width,height:t.height}),S=t.positionInput||h.closest("li").find(".img-position-input"),y=t.typeInput||h.closest("li").find(".img-type-input"),s.removeClass("loading"),a(v,t.minSize||minSize,t.select)}var s=i("#js-crop-modal"),d=s.find(".modal-body"),u=i("#js-img-type"),p=u.find("option"),m=null,f=i("#js-preview-img"),g=i("#preview-item-tpl").html(),h=null,v=null,S=null,y=null,z=i("#js-img-count");actualSize=null,previewSize=[120,80],index=0,minSize=t().minSize,typeObject=e(),s.on("hidden.bs.modal",function(){var i=t().type;y.val(i),l(m.tellSelect()),y.closest("li").find(".img-tit").text(typeObject[i].text),m&&m.destroy(),d.html(""),u[0].selectedIndex=0}),f.on("click",".img-crop",function(){s.modal("show").addClass("loading");var t=i(this).closest("li"),e=t.find(".img-position-input"),n=t.find(".img-type-input"),a=t.find("img"),o=i.parseJSON(e.val());actualSize=[a.data("width"),a.data("height")],c({url:a.attr("src"),positionInput:e,typeInput:n,img:a,select:[o.x,o.y,o.x2,o.y2],minSize:typeObject[n.val()].minSize})}),u.on("change",function(){var t=i(this),e=typeObject[t.val()].minSize,n=[0,0].concat(e);m&&m.destroy(),a(v,e,n)}),f.on("click",".img-del",function(){i(this).closest("li").remove()}),i("#js-uploadify").uploadify({buttonText:"浏览并上传",buttonClass:"btn-info",swf:"/static/back-assets/dist/uploadify/uploadify.swf",uploader:"/petfarm/petfarm/picadd/upload/",fileTypeExts:"*.jpg;*.jpeg;*.gif;*.png;*.bmp;",fileSizeLimit:"4MB",multi:"false",formData:{},onUploadError:function(i,t,e,n){"500"==e&&(n="服务器内部错误"),alert('"'+i.name+'" 上传失败：'+n+"，请重试！")},onUploadSuccess:function(t,e,a){return a?(e=i.parseJSON(e),actualSize=[e.width,e.height],s.modal("show").addClass("loading"),n(e.url,function(){index++,z.val(index),c(e)}),void 0):(alert("请求超时，请稍后重试！"),void 0)}})}}(jQuery);