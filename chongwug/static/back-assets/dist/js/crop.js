!function(i){i.crop=function(t){function e(){var i=m.filter(":selected");return{minSize:i.data("size"),type:i.attr("value")}}function n(){var t={};return i.each(m,function(e,n){var a=i(n);t[a.attr("value")]={minSize:a.data("size"),text:a.text()}}),t}function a(t,e){var n=i("<img>");n.on("load",function(){e()}),n.attr("src",t)}function o(t,e,n){var a=e[0]/e[1];t.Jcrop({aspectRatio:a,minSize:e,setSelect:[0,0,e[0],e[1]]},function(){f=this}),i.isArray(n)&&f.setSelect(n)}function l(i){y.val(JSON.stringify(i))}function s(i){var t=previewSize[0]/i.w,e=previewSize[1]/i.h;v.css({width:Math.round(t*actualSize[0])+"px",height:Math.round(e*actualSize[1])+"px",marginLeft:"-"+Math.round(t*i.x)+"px",marginTop:"-"+Math.round(e*i.y)+"px"}),l(i)}function r(i){var t=h;for(var e in i)t=t.replace(new RegExp("{"+e+"}","gm"),i[e]);return t}function u(t){S=d.html('<img src="'+t.url+'">').find("img"),v=t.img||i(r({src:t.url,index:index})).appendTo(g).find("img"),t.img||v.data({width:t.width,height:t.height}),y=t.positionInput||v.closest("li").find(".img-position-input"),z=t.typeInput||v.closest("li").find(".img-type-input"),c.removeClass("loading"),o(S,t.minSize||minSize,t.select)}var c=i("#js-crop-modal"),d=c.find(".modal-body"),p=i("#js-img-type"),m=p.find("option"),f=null,g=i("#js-preview-img"),h=i("#preview-item-tpl").html(),v=null,S=null,y=null,z=null,x=i("#js-img-count");actualSize=null,previewSize=[120,80],index=0,minSize=e().minSize,typeObject=n(),c.on("hidden.bs.modal",function(){var i=e().type;z.val(i),s(f.tellSelect()),z.closest("li").find(".img-tit").text(typeObject[i].text),f&&f.destroy(),d.html(""),p[0].selectedIndex=0}),g.on("click",".img-crop",function(){c.modal("show").addClass("loading");var t=i(this).closest("li"),e=t.find(".img-position-input"),n=t.find(".img-type-input"),a=t.find("img"),o=i.parseJSON(e.val());actualSize=[a.data("width"),a.data("height")],u({url:a.attr("src"),positionInput:e,typeInput:n,img:a,select:[o.x,o.y,o.x2,o.y2],minSize:typeObject[n.val()].minSize})}),p.on("change",function(){var t=i(this),e=typeObject[t.val()].minSize,n=[0,0].concat(e);f&&f.destroy(),o(S,e,n)}),g.on("click",".img-del",function(){i(this).closest("li").remove()}),i("#js-uploadify").uploadify({buttonText:"浏览并上传",buttonClass:"btn-info",swf:"/static/back-assets/dist/uploadify/uploadify.swf",uploader:t.uploader,fileTypeExts:"*.jpg;*.jpeg;*.gif;*.png;*.bmp;",fileSizeLimit:"4MB",multi:"false",formData:{},onUploadError:function(i,t,e,n){"500"==e&&(n="服务器内部错误"),alert('"'+i.name+'" 上传失败：'+n+"，请重试！")},onUploadSuccess:function(t,e,n){return n?(e=i.parseJSON(e),void(0==e.status?(actualSize=[e.width,e.height],c.modal("show").addClass("loading"),a(e.url,function(){index++,x.val(index),u(e)})):alert("图片上传失败："+e.message+"，请重试。"))):void alert("请求超时，请稍后重试！")}})}}(jQuery);