!function(i){i.crop=function(t){function e(){return!!h.find(".img-main-input").filter(":checked").length}function n(){var i=f.filter(":selected");return{minSize:i.data("size"),type:i.attr("value")}}function a(){var t={};return i.each(f,function(e,n){var a=i(n);t[a.attr("value")]={minSize:a.data("size"),text:a.text()}}),t}function o(t,e){var n=i("<img>");n.on("load",function(){e()}),n.attr("src",t)}function l(t,e,n){var a=e[0]/e[1];t.Jcrop({aspectRatio:a,minSize:e,setSelect:[0,0,e[0],e[1]]},function(){g=this}),i.isArray(n)&&g.setSelect(n)}function r(i){z.val(JSON.stringify(i))}function c(i){var t=previewSize[0]/i.w,e=previewSize[1]/i.h;S.css({width:Math.round(t*actualSize[0])+"px",height:Math.round(e*actualSize[1])+"px",marginLeft:"-"+Math.round(t*i.x)+"px",marginTop:"-"+Math.round(e*i.y)+"px"}),r(i)}function u(i){var t=v;for(var e in i)t=t.replace(new RegExp("{"+e+"}","gm"),i[e]);return t}function d(t){y=p.html('<img src="'+t.url+'">').find("img"),S=t.img||i(u({src:t.url,index:index})).appendTo(h).find("img"),t.img||(S.data({width:t.width,height:t.height}),e()||S.closest("li").find(".img-main-input").prop("checked",!0)),z=t.positionInput||S.closest("li").find(".img-position-input"),x=t.typeInput||S.closest("li").find(".img-type-input"),s.removeClass("loading"),l(y,t.minSize||minSize,t.select)}var s=i("#js-crop-modal"),p=s.find(".modal-body"),m=i("#js-img-type"),f=m.find("option"),g=null,h=i("#js-preview-img"),v=i("#preview-item-tpl").html(),S=null,y=null,z=null,x=null,w=i("#js-img-count");actualSize=null,previewSize=[120,80],index=0,minSize=n().minSize,typeObject=a(),s.on("hidden.bs.modal",function(){var i=n().type;x.val(i),c(g.tellSelect()),g&&g.destroy(),p.html(""),m[0].selectedIndex=0}),h.on("click",".img-crop",function(){s.modal("show").addClass("loading");var t=i(this).closest("li"),e=t.find(".img-position-input"),n=t.find(".img-type-input"),a=t.find("img"),o=i.parseJSON(e.val());actualSize=[a.data("width"),a.data("height")],d({url:a.attr("src"),positionInput:e,typeInput:n,img:a,select:[o.x,o.y,o.x2,o.y2],minSize:typeObject[n.val()].minSize})}),m.on("change",function(){var t=i(this),e=typeObject[t.val()].minSize,n=[0,0].concat(e);g&&g.destroy(),l(y,e,n)}),h.on("click",".img-del",function(){if(i(this).closest("li").remove(),!e()){var t=h.find(".img-main-input").first();t.length&&t.prop("checked",!0)}}),i("#js-uploadify").uploadify({buttonText:"浏览并上传",buttonClass:"btn-info",swf:t.swf,uploader:t.uploader,fileTypeExts:"*.jpg;*.jpeg;*.gif;*.png;*.bmp;",fileSizeLimit:"4MB",multi:!1,formData:{},onUploadError:function(i,t,e,n){"500"==e&&(n="服务器内部错误"),alert('"'+i.name+'" 上传失败：'+n+"，请重试！")},onUploadSuccess:function(t,e,n){return n?(e=i.parseJSON(e),0==e.status?(actualSize=[e.width,e.height],s.modal("show").addClass("loading"),o(e.url,function(){index++,w.val(index),d(e)})):alert("图片上传失败："+e.message+"，请重试。"),void 0):(alert("请求超时，请稍后重试！"),void 0)}})}}(jQuery);