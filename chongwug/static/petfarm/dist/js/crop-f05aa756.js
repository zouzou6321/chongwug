!function(i){i.fn.uploadAndCrop=function(t){var e=i.extend({previewItemTpl:"#preview-item-tpl",uploadBtn:"#js-uploadify",cropModal:"#js-crop-modal",imgCount:"#js-img-count",previewSize:[120,80],buttonText:"浏览并上传",buttonClass:"btn-info",fileTypeExts:"*.jpg;*.jpeg;*.gif;*.png;*.bmp;",fileSizeLimit:"4MB",multi:!1,formData:{}},t);return this.each(function(){function t(i){var t=l;for(var e in i)t=t.replace(new RegExp("{"+e+"}","gm"),i[e]);return t}function n(){return!!a.find(".img-main-input").filter(":checked").length}function o(i){var t=c[0]/i.w,e=c[1]/i.h;m.css({width:Math.round(t*w[0])+"px",height:Math.round(e*w[1])+"px",marginLeft:"-"+Math.round(t*i.x)+"px",marginTop:"-"+Math.round(e*i.y)+"px"}),f.find(".img-position-input").val(JSON.stringify(i))}var r=i(this),a=r.find(".preview-img"),a=a.length?a:i("<ul>").addClass("preview-img").appendTo(r),l=i(e.previewItemTpl).html(),d=r.find(e.uploadBtn),p=i(e.cropModal),u=p.find(".modal-body"),s=i(e.imgCount),c=e.previewSize,g=u.find("img").length?u.find("img"):i("<img>").appendTo(u),m=null,f=null,h=null,v=r.data("size"),C=v[0]/v[1],w=[],x=0;r.on("uploadAndCrop.uploadSuccess",function(i,t){w=[t.width,t.height],p.addClass("loading").modal("show"),r.trigger("uploadAndCrop.preloadImg",t)}),r.on("uploadAndCrop.preloadImg",function(t,e){var n=i("<img>");n.on("load",function(){x++,s.val(x),r.trigger("uploadAndCrop.initCrop",e)}).attr("src",e.url)}),r.on("uploadAndCrop.initCrop",function(e,o){g.attr("src",o.url).removeAttr("style"),o.img?m=o.img:(f=i(t({src:o.url,index:x})).appendTo(a),m=f.find("img").data({width:o.width,height:o.height}),n()||f.find(".img-main-input").prop("checked",!0)),r.trigger("uploadAndCrop.startCrop",{select:o.select})}),r.on("uploadAndCrop.startCrop",function(t,e){p.removeClass("loading"),g.Jcrop({aspectRatio:C,minSize:v,setSelect:[0,0,v[0],v[1]]},function(){h=this}),i.isArray(e.select)&&h.setSelect(e.select)}),p.on("hidden.bs.modal",function(){o(h.tellSelect()),h.destroy()}),a.on("click",".img-crop",function(){p.addClass("loading").modal("show"),f=i(this).closest("li");var t=f.find(".img-position-input"),e=f.find("img"),n=e.data(),o=i.parseJSON(t.val());w=[n.width,n.height],r.trigger("uploadAndCrop.initCrop",{url:e.attr("src"),img:e,width:n.width,height:n.height,select:[o.x,o.y,o.x2,o.y2]})}),a.on("click",".img-del",function(){var t=i(this).closest("li");if(e.beforeDel&&e.beforeDel(t.data("id")),t.remove(),!n()){var o=a.find(".img-main-input").first();o.length&&o.prop("checked",!0)}}),d.uploadify({buttonText:e.buttonText,buttonClass:e.buttonClass,swf:e.swf,uploader:e.uploader,fileTypeExts:e.fileTypeExts,fileSizeLimit:e.fileSizeLimit,multi:e.multi,formData:e.formData,onUploadError:function(i,t,e,n){"500"==e&&(n="服务器内部错误"),alert('"'+i.name+'" 上传失败：'+n+"，请重试！")},onUploadSuccess:function(t,e,n){return n?(e=i.parseJSON(e),0==e.status?r.trigger("uploadAndCrop.uploadSuccess",e):alert("图片上传失败："+e.message+"，请重试。"),void 0):(alert("请求超时，请稍后重试！"),void 0)}})})}}(jQuery);