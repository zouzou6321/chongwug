!function(i){i.fn.uploadAndCrop=function(t){var e=i.extend({previewItemTpl:"#preview-item-tpl",uploadBtn:"#js-uploadify",cropModal:"#js-crop-modal",imgCount:"#js-img-count",previewSize:[120,80],buttonText:"浏览并上传",buttonClass:"btn-info",fileTypeExts:"*.jpg;*.jpeg;*.gif;*.png;*.bmp;",fileSizeLimit:"4MB",multi:!1,formData:{}},t);return this.each(function(){function t(i){var t=l;for(var e in i)t=t.replace(new RegExp("{"+e+"}","gm"),i[e]);return t}function o(){return!!a.find(".img-main-input").filter(":checked").length}function n(i){var t=s[0]/i.w,e=s[1]/i.h;g.css({width:Math.round(t*C[0])+"px",height:Math.round(e*C[1])+"px",marginLeft:"-"+Math.round(t*i.x)+"px",marginTop:"-"+Math.round(e*i.y)+"px"}),m.find(".img-position-input").val(JSON.stringify(i))}var r=i(this),a=r.find(".preview-img"),a=a.length?a:i("<ul>").addClass("preview-img").appendTo(r),l=i(e.previewItemTpl).html(),d=r.find(e.uploadBtn),p=i(e.cropModal),u=i(e.imgCount),s=e.previewSize,c=i("<img>").appendTo(p.find(".modal-body")),g=null,m=null,f=null,h=r.data("size"),v=h[0]/h[1],C=[],w=0;r.on("uploadAndCrop.uploadSuccess",function(i,t){C=[t.width,t.height],p.addClass("loading").modal("show"),r.trigger("uploadAndCrop.preloadImg",t)}),r.on("uploadAndCrop.preloadImg",function(t,e){var o=i("<img>");o.on("load",function(){w++,u.val(w),r.trigger("uploadAndCrop.initCrop",e)}).attr("src",e.url)}),r.on("uploadAndCrop.initCrop",function(e,n){c.attr("src",n.url).removeAttr("style"),n.img?g=n.img:(m=i(t({src:n.url,index:w})).appendTo(a),g=m.find("img").data({width:n.width,height:n.height}),o()||m.find(".img-main-input").prop("checked",!0)),r.trigger("uploadAndCrop.startCrop",{select:n.select})}),r.on("uploadAndCrop.startCrop",function(t,e){p.removeClass("loading"),c.Jcrop({aspectRatio:v,minSize:h,setSelect:[0,0,h[0],h[1]]},function(){f=this}),i.isArray(e.select)&&f.setSelect(e.select)}),p.on("hidden.bs.modal",function(){n(f.tellSelect()),f.destroy()}),a.on("click",".img-crop",function(){p.addClass("loading").modal("show"),m=i(this).closest("li");var t=m.find(".img-position-input"),e=m.find("img"),o=e.data(),n=i.parseJSON(t.val());C=[o.width,o.height],r.trigger("uploadAndCrop.initCrop",{url:e.attr("src"),img:e,width:o.width,height:o.height,select:[n.x,n.y,n.x2,n.y2]})}),a.on("click",".img-del",function(){var t=i(this).closest("li");if(e.beforeDel&&e.beforeDel(t.data("id")),t.remove(),!o()){var n=a.find(".img-main-input").first();n.length&&n.prop("checked",!0)}}),d.uploadify({buttonText:e.buttonText,buttonClass:e.buttonClass,swf:e.swf,uploader:e.uploader,fileTypeExts:e.fileTypeExts,fileSizeLimit:e.fileSizeLimit,multi:e.multi,formData:e.formData,onUploadError:function(i,t,e,o){"500"==e&&(o="服务器内部错误"),alert('"'+i.name+'" 上传失败：'+o+"，请重试！")},onUploadSuccess:function(t,e,o){return o?(e=i.parseJSON(e),void(0==e.status?r.trigger("uploadAndCrop.uploadSuccess",e):alert("图片上传失败："+e.message+"，请重试。"))):void alert("请求超时，请稍后重试！")}})})}}(jQuery);