{% extends 'petfarm/tpl/base/base.html' %}

{% block title %}内容编辑{% endblock %}

{% block css %}
<link rel="stylesheet" href="/static/back-assets/dist/uploadify/uploadify.css"/>
<link rel="stylesheet" href="/static/back-assets/dist/jcrop/jquery.Jcrop.css"/>
<link rel="stylesheet" href="/static/back-assets/dist/imgcut/css/imgareaselect-default.css"/>
{% endblock %}

{% block main %}

<style>
    .pet{
        border: 1px solid #ccc;
        padding-top: 15px;
        margin-bottom: 15px;
        position: relative;
    }

    .pet .btn-del{
        position: absolute;
        top: 15px;
        left: 15px;
    }
</style>

<h1 class="page-header">添加一窝宠物信息</h1>
<p>加*为必填项</p>

<form method="post" action="./" class="form-horizontal" id="js-form">
    {% csrf_token %}
    <input name="count" type="hidden" id="pet-count" value="0"/>
    <div class="form-group">
        <label for="nest-type" class="col-sm-3 control-label">本窝品种<span class="warn">*</span>：</label>
        <div class="col-sm-4">
          <input type="text" class="form-control required" id="nest-type" name="nest-type">
        </div>
    </div>
    <div class="form-group">
        <label for="nest-color" class="col-sm-3 control-label">本窝颜色<span class="warn">*</span>：</label>
        <div class="col-sm-4">
          <input type="text" class="form-control required" id="nest-color" name="nest-color">
        </div>
    </div>
    <div class="form-group">
        <label for="nest-age" class="col-sm-3 control-label">本窝月龄<span class="warn">*</span>：</label>
        <div class="col-sm-4">
          <input type="text" class="form-control required number" id="nest-age" name="nest-age">
        </div>
    </div>
    <div class="form-group">
        <label for="nest-desc" class="col-sm-3 control-label">本窝简介（最多20字）<span class="warn">*</span>：</label>
        <div class="col-sm-4">
          <input type="text" class="form-control required number" id="nest-desc" name="nest-desc">
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-3 control-label">本窝图片（至少一张）<span class="warn">*</span>：</label>
        <div class="col-sm-4">
            <div id="js-uploadify"></div>
        </div>
    </div>
    <div class="form-group">
        <div class="col-sm-offset-1 col-sm-10">
            <ul class="preview-img"></ul>
        </div>
    </div>
    <div class="pet">
        <div class="form-group">
            <label class="col-sm-3 control-label">宠物颜色<span class="warn">*</span>：</label>
            <div class="col-sm-4">
              <input type="text" class="form-control required" name="color1">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">宠物价格<span class="warn">*</span>：</label>
            <div class="col-sm-4">
              <input type="text" class="form-control required number" name="price1">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">防疫状态<span class="warn">*</span>：</label>
            <div class="col-sm-4">
                <select name="epidemic1" class="form-control">
                    <option value="未种疫苗">未种疫苗</option>
                    <option value="未种疫苗">未种疫苗</option>
                    <option value="已种疫苗">已种疫苗</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">宠物性别<span class="warn">*</span>：</label>
            <div class="col-sm-4">
                <select name="sex1" class="form-control">
                    <option value="公">公</option>
                    <option value="母">母</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">销售状态<span class="warn">*</span>：</label>
            <div class="col-sm-4">
                <select name="sale1" class="form-control">
                    <option value="0">在售</option>
                    <option value="1">售光</option>
                </select>
            </div>
        </div>
    </div>
    <div class="form-group">
        <div class="col-sm-2">
          <button type="button" class="btn btn-success btn-add form-control">添加宠物</button>
        </div>
    </div>
    <div class="form-group">
        <div class="col-sm-offset-3 col-sm-4">
          <button type="submit" class="btn btn-primary form-control">提交</button>
        </div>
    </div>
</form>

<div class="modal fade modal-auto-width" id="js-crop-modal" data-backdrop="static">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title">裁剪图片</h4>
      </div>
      <div class="modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary">确定</button>
      </div>
    </div>
    <div class="modal-loading"></div>
  </div>
</div>

<script type="text/html" id="pet-tpl">

<div class="pet">
    <div class="form-group">
        <label class="col-sm-3 control-label">宠物颜色<span class="warn">*</span>：</label>
        <div class="col-sm-4">
          <input type="text" class="form-control required" name="color{num}">
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-3 control-label">宠物价格<span class="warn">*</span>：</label>
        <div class="col-sm-4">
          <input type="text" class="form-control required number" name="price{num}">
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-3 control-label">防疫状态<span class="warn">*</span>：</label>
        <div class="col-sm-4">
            <select name="epidemic{num}" class="form-control">
                <option value="未种疫苗">未种疫苗</option>
                <option value="未种疫苗">未种疫苗</option>
                <option value="已种疫苗">已种疫苗</option>
            </select>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-3 control-label">宠物性别<span class="warn">*</span>：</label>
        <div class="col-sm-4">
            <select name="sex{num}" class="form-control">
                <option value="0">公</option>
                <option value="1">母</option>
            </select>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-3 control-label">销售状态<span class="warn">*</span>：</label>
        <div class="col-sm-4">
            <select name="sale{num}" class="form-control">
                <option value="0">在售</option>
                <option value="1">售光</option>
            </select>
        </div>
    </div>
    <button class="btn-del btn btn-danger" type="button">删除</button>
</div>

</script>

<script type="text/html" id="preview-item-tpl">
<li>
    <img src="{src}"/>
    <input type="hidden"/>
    <div class="img-edit">
        <i class="glyphicon glyphicon-pencil img-crop"></i>
        <i class="glyphicon glyphicon-remove img-del"></i>
    </div>
</li>
</script>

{% endblock %}

{% block scripts %}
<script>

(function($){
    var $form = $('#js-form');

    //$form.validate(commonvalidateConfig);

    var petTpl = $('#pet-tpl').html(),
        num = 1;

    $form.on('click', '.btn-add', function(){
        num++;
        $(this).closest('.form-group').before(petTpl.replace(/\{num\}/g, num));
    });

    $form.on('click', '.btn-del', function(){
        $(this).closest('.pet').remove();
    });

    $form.on('submit', function(){
        $('#pet-count').val(num);
    });

})(jQuery);

</script>
<script src="/static/back-assets/dist/uploadify/jquery.uploadify.min.js"></script>
<script src="/static/back-assets/dist/jcrop/jquery.Jcrop.min.js"></script>
<script src="/static/back-assets/dist/imgcut/scripts/jquery.imgareaselect.min.js"></script>
<script>

(function($){

    var $cropModal = $('#js-crop-modal'),
        $cropModalBody = $cropModal.find('.modal-body'),
        jcrop = null,
        $previewImg = $('.preview-img'),
        $previewItemTpl = $('#preview-item-tpl').html(),
        $currPreview = null,
        $currInput = null,
        actualSize = null;

    //预加载图片
    function loadImage(url, callback){
        var $img = $('<img>');

        $img.on('load', function(){
            callback();
        });

        $img.attr('src', url);
    }

    //开始截图
    function startCrop($img, select){
        $img.Jcrop({
            aspectRatio: 1.5,
            minSize: [600, 400],
            setSelect: [0, 0, 600, 400],
            onChange: syncPreview,
            onSelect: syncPreview
        }, function(){
            jcrop = this;
        });

        if($.isArray(select)){
            jcrop.setSelect(select);
        }
    }

    //同步截图数据到 input hidden
    function updateCoords(coords){
        $currInput.val(JSON.stringify(coords));
    }

    //同步更新缩略图
    function syncPreview(coords){
        var rx = 120 / coords.w;
        var ry = 80 / coords.h;

        $currPreview.css({
            width: Math.round(rx * actualSize[0]) + 'px',
            height: Math.round(ry * actualSize[1]) + 'px',
            marginLeft: '-' + Math.round(rx * coords.x) + 'px',
            marginTop: '-' + Math.round(ry * coords.y) + 'px'
        });

        updateCoords(coords);
    }

    //上传图片成功后准备开始截图
    function afterUploadSuccess(data){
        var $img = $cropModalBody.html('<img src="'+ data.url +'">').find('img');
        $currPreview = data.img || $($previewItemTpl.replace('{src}', data.url)).appendTo($previewImg).find('img');

        if(!data.img){
            $currPreview.data({width: data.width, height: data.height});
        }

        $currInput = data.input || $currPreview.closest('li').find('input');
        $cropModal.removeClass('loading');
        startCrop($img, data.select);
    }

    //关闭截图弹窗后
    $cropModal.on('hidden.bs.modal', function(){
        jcrop && jcrop.destroy();
        $cropModalBody.html('');
    });

    //重新截取图片
    $previewImg.on('click', '.img-crop', function(){
        $cropModal.modal('show').addClass('loading');

        var $currLi = $(this).closest('li'),
            $input = $currLi.find('input'),
            $img = $currLi.find('img'),
            select = $.parseJSON($input.val());

        actualSize = [$img.data('width'), $img.data('height')];

        afterUploadSuccess({
            url: $img.attr('src'),
            input: $input,
            img: $img,
            select: [select.x, select.y, select.x2, select.y2]
        });
    });

    //删除图片
    $previewImg.on('click', '.img-del', function(){
        $(this).closest('li').remove();
    });

    $('#js-uploadify').uploadify({
        buttonText: '浏览并上传',
        buttonClass: 'btn-info',
        swf: '/static/back-assets/dist/uploadify/uploadify.swf',
        uploader: '/petfarm/petfarm/picadd/upload/',
        fileTypeExts: '*.jpg;*.jpeg;*.gif;*.png;*.bmp;',
        fileSizeLimit: '4MB',
        multi: 'false',
        formData: {},
        onUploadError: function(file, errorCode, errorMsg, errorString){
            if(errorMsg == "500"){
                errorString = '服务器内部错误';
            }

            alert('"' + file.name + '" 上传失败：' + errorString + '，请重试！');
        },
        onUploadSuccess: function(file, data, response){
            if (!response) {
                alert('请求超时，请稍后重试！');
                return;
            }

            data = $.parseJSON(data);
            actualSize = [data.width, data.height];

            $cropModal.modal('show').addClass('loading');
            loadImage(data.url, function(){
                afterUploadSuccess(data);
            });
        }
    });

})(jQuery);

</script>
{% endblock %}