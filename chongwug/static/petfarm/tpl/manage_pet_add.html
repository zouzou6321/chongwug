{% extends 'petfarm/tpl/base/base.html' %}

{% block title %}内容编辑{% endblock %}

{% block css %}
<link rel="stylesheet" href="/static/back-assets/dist/uploadify/uploadify.css"/>
<link rel="stylesheet" href="/static/back-assets/dist/jcrop/jquery.Jcrop.css"/>
<link rel="stylesheet" href="/static/back-assets/dist/imgcut/css/imgareaselect-default.css"/>
{% endblock %}

{% block main %}

<style>
    .pet{
        border: 1px solid #ccc;
        padding-top: 15px;
        margin-bottom: 15px;
        position: relative;
    }

    .pet .btn-del{
        position: absolute;
        top: 15px;
        left: 15px;
    }
</style>

<h1 class="page-header">添加一窝宠物信息</h1>
<p>加*为必填项</p>

<form method="post" action="./" class="form-horizontal" id="js-form">
    {% csrf_token %}
    <input name="count" type="hidden" id="pet-count" value="0"/>
    <div class="form-group">
        <label for="nest-type" class="col-sm-3 control-label">本窝品种<span class="warn">*</span>：</label>
        <div class="col-sm-4">
          <input type="text" class="form-control required" id="nest-type" name="nest-type">
        </div>
    </div>
    <div class="form-group">
        <label for="nest-color" class="col-sm-3 control-label">本窝颜色<span class="warn">*</span>：</label>
        <div class="col-sm-4">
          <input type="text" class="form-control required" id="nest-color" name="nest-color">
        </div>
    </div>
    <div class="form-group">
        <label for="nest-age" class="col-sm-3 control-label">本窝月龄<span class="warn">*</span>：</label>
        <div class="col-sm-4">
          <input type="text" class="form-control required number" id="nest-age" name="nest-age">
        </div>
    </div>
    <div class="form-group">
        <label for="nest-desc" class="col-sm-3 control-label">本窝简介（最多20字）<span class="warn">*</span>：</label>
        <div class="col-sm-4">
          <input type="text" class="form-control required number" id="nest-desc" name="nest-desc">
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-3 control-label">本窝图片（至少一张）<span class="warn">*</span>：</label>
        <div class="col-sm-4">
            <div id="js-uploadify"></div>
        </div>
    </div>
    <div class="form-group">
        <div class="col-sm-offset-1 col-sm-10">
            <ul class="preview-img" id="js-preview-img"></ul>
        </div>
    </div>
    <div class="pet">
        <div class="form-group">
            <label class="col-sm-3 control-label">宠物颜色<span class="warn">*</span>：</label>
            <div class="col-sm-4">
              <input type="text" class="form-control required" name="color1">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">宠物价格<span class="warn">*</span>：</label>
            <div class="col-sm-4">
              <input type="text" class="form-control required number" name="price1">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">防疫状态<span class="warn">*</span>：</label>
            <div class="col-sm-4">
                <select name="epidemic1" class="form-control">
                    <option value="未种疫苗">未种疫苗</option>
                    <option value="未种疫苗">未种疫苗</option>
                    <option value="已种疫苗">已种疫苗</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">宠物性别<span class="warn">*</span>：</label>
            <div class="col-sm-4">
                <select name="sex1" class="form-control">
                    <option value="公">公</option>
                    <option value="母">母</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">销售状态<span class="warn">*</span>：</label>
            <div class="col-sm-4">
                <select name="sale1" class="form-control">
                    <option value="0">在售</option>
                    <option value="1">售光</option>
                </select>
            </div>
        </div>
    </div>
    <div class="form-group">
        <div class="col-sm-2">
          <button type="button" class="btn btn-success btn-add form-control">添加宠物</button>
        </div>
    </div>
    <div class="form-group">
        <div class="col-sm-offset-3 col-sm-4">
          <button type="submit" class="btn btn-primary form-control">提交</button>
        </div>
    </div>
</form>

<div class="modal fade modal-auto-width" id="js-crop-modal" data-backdrop="static">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title">裁剪图片</h4>
        <div class="form-horizontal img-type-group">
            <label class="col-sm-6 control-label">图片用途：</label>
            <div class="col-sm-6">
                <select class="form-control" id="js-img-type">
                    <option value="normal" data-size="[600, 400]" selected>展示图</option>
                    <option value="main" data-size="[800, 600]">主图</option>
                </select>
            </div>
        </div>
      </div>
      <div class="modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">确定</button>
      </div>
    </div>
    <div class="modal-loading"></div>
  </div>
</div>

<script type="text/html" id="pet-tpl">

<div class="pet">
    <div class="form-group">
        <label class="col-sm-3 control-label">宠物颜色<span class="warn">*</span>：</label>
        <div class="col-sm-4">
          <input type="text" class="form-control required" name="color{num}">
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-3 control-label">宠物价格<span class="warn">*</span>：</label>
        <div class="col-sm-4">
          <input type="text" class="form-control required number" name="price{num}">
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-3 control-label">防疫状态<span class="warn">*</span>：</label>
        <div class="col-sm-4">
            <select name="epidemic{num}" class="form-control">
                <option value="未种疫苗">未种疫苗</option>
                <option value="未种疫苗">未种疫苗</option>
                <option value="已种疫苗">已种疫苗</option>
            </select>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-3 control-label">宠物性别<span class="warn">*</span>：</label>
        <div class="col-sm-4">
            <select name="sex{num}" class="form-control">
                <option value="0">公</option>
                <option value="1">母</option>
            </select>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-3 control-label">销售状态<span class="warn">*</span>：</label>
        <div class="col-sm-4">
            <select name="sale{num}" class="form-control">
                <option value="0">在售</option>
                <option value="1">售光</option>
            </select>
        </div>
    </div>
    <button class="btn-del btn btn-danger" type="button">删除</button>
</div>

</script>

<script type="text/html" id="preview-item-tpl">
<li>
    <div class="img-box">
        <img src="{src}"/>
        <input type="hidden" name="img-{index}-position" class="img-position-input"/>
        <input type="hidden" name="img-{index}-type" class="img-type-input"/>
        <input type="hidden" name="img-{index}" value="{src}" class="img-index-input"/>
    </div>
    <p class="img-tit"></p>
    <div class="img-edit">
        <i class="glyphicon glyphicon-pencil img-crop"></i>
        <i class="glyphicon glyphicon-remove img-del"></i>
    </div>
</li>
</script>

{% endblock %}

{% block scripts %}
<script>

(function($){
    var $form = $('#js-form');

    //$form.validate(commonvalidateConfig);

    var petTpl = $('#pet-tpl').html(),
        num = 1;

    $form.on('click', '.btn-add', function(){
        num++;
        $(this).closest('.form-group').before(petTpl.replace(/\{num\}/g, num));
    });

    $form.on('click', '.btn-del', function(){
        $(this).closest('.pet').remove();
    });

    $form.on('submit', function(){
        $('#pet-count').val(num);
    });

})(jQuery);

</script>
<script src="/static/back-assets/dist/uploadify/jquery.uploadify.min.js"></script>
<script src="/static/back-assets/dist/jcrop/jquery.Jcrop.min.js"></script>
<script src="/static/back-assets/dist/imgcut/scripts/jquery.imgareaselect.min.js"></script>
<script>

(function($){
    /*modal*/
    var $cropModal = $('#js-crop-modal'),
        $cropModalBody = $cropModal.find('.modal-body'),

    /*image type, min-size, radio*/
        $imgType = $('#js-img-type'),
        $imgTypeOption = $imgType.find('option'),

    /*jcrop api*/
        jcrop = null,

    /*preview wrapper*/
        $previewImg = $('#js-preview-img'),
    
    /*preview item template for insert*/
        $previewItemTpl = $('#preview-item-tpl').html(),
    
    /*current preview item, for update preview*/
        $currPreview = null,
        $currCropImg = null,
    /*store current image's position data*/
        $currPositionInput = null,
        $currTypeInput = null,

    /*point to current image's actual size*/
        actualSize = null,

    /*point to current image's preview size*/
        previewSize = [120, 80],

    /*point to current index of the upload image, start from 1*/
        index = 0,

        minSize = getSizeInfo().minSize,
        typeObject = generateTypeObject();

    function getSizeInfo(){
        var $selected = $imgTypeOption.filter(':selected');

        return {
            minSize: $selected.data('size'),
            type: $selected.attr('value')
        };
    }

    function generateTypeObject(){
        var o = {};

        $.each($imgTypeOption, function(i, e){
            var $e = $(e);

            o[$e.attr('value')] = {
              minSize: $e.data('size'),
              text: $e.text()
            };
        });

        return o;
    }

    //预加载图片
    function loadImage(url, callback){
        var $img = $('<img>');

        $img.on('load', function(){
            callback();
        });

        $img.attr('src', url);
    }

    //开始截图
    function startCrop($img, minSize, select){
        var radio = minSize[0] / minSize[1];

        $img.Jcrop({
            aspectRatio: radio,
            minSize: minSize,
            setSelect: [0, 0, minSize[0], minSize[1]]
        }, function(){
            jcrop = this;
        });

        if($.isArray(select)){
            jcrop.setSelect(select);
        }
    }

    //同步截图数据到 input hidden
    function updateCoords(coords){
        $currPositionInput.val(JSON.stringify(coords));
    }

    //同步更新缩略图
    function syncPreview(coords){
        var rx = previewSize[0] / coords.w;
        var ry = previewSize[1] / coords.h;

        $currPreview.css({
            width: Math.round(rx * actualSize[0]) + 'px',
            height: Math.round(ry * actualSize[1]) + 'px',
            marginLeft: '-' + Math.round(rx * coords.x) + 'px',
            marginTop: '-' + Math.round(ry * coords.y) + 'px'
        });

        updateCoords(coords);
    }

    function compileTpl(data){
        var tpl = $previewItemTpl;

        for(var i in data){
            tpl = tpl.replace(new RegExp('{'+ i +'}', 'gm'), data[i]);
        }

        return tpl;
    }

    //上传图片成功后准备开始截图
    function afterUploadSuccess(data){
        $currCropImg = $cropModalBody.html('<img src="'+ data.url +'">').find('img');

        $currPreview = data.img || $(compileTpl({src: data.url, index: index})).appendTo($previewImg).find('img');

        if(!data.img){
            $currPreview.data({width: data.width, height: data.height});
        }

        $currPositionInput = data.positionInput || $currPreview.closest('li').find('.img-position-input');
        $currTypeInput = data.typeInput || $currPreview.closest('li').find('.img-type-input');

        $cropModal.removeClass('loading');
        startCrop($currCropImg, data.minSize || minSize, data.select);
    }

    //关闭截图弹窗后
    $cropModal.on('hidden.bs.modal', function(){
        //store type info
        var type = getSizeInfo().type;

        $currTypeInput.val(type);
        syncPreview(jcrop.tellSelect());

        $currTypeInput.closest('li').find('.img-tit').text(typeObject[type].text);

        jcrop && jcrop.destroy();
        $cropModalBody.html('');
        $imgType[0].selectedIndex = 0;
    });

    //重新截取图片
    $previewImg.on('click', '.img-crop', function(){
        $cropModal.modal('show').addClass('loading');

        var $currLi = $(this).closest('li'),
            $positionInput = $currLi.find('.img-position-input'),
            $typeInput = $currLi.find('.img-type-input'),
            $img = $currLi.find('img'),
            select = $.parseJSON($positionInput.val());

        actualSize = [$img.data('width'), $img.data('height')];

        afterUploadSuccess({
            url: $img.attr('src'),
            positionInput: $positionInput,
            typeInput: $typeInput,
            img: $img,
            select: [select.x, select.y, select.x2, select.y2],
            minSize: typeObject[$typeInput.val()].minSize
        });
    });

    //update crop area when image type select change
    $imgType.on('change', function(){
        var $this = $(this),
            minSize = typeObject[$this.val()].minSize,
            select = [0, 0].concat(minSize);

        jcrop && jcrop.destroy();
        startCrop($currCropImg, minSize, select);
    });

    //删除图片
    $previewImg.on('click', '.img-del', function(){
        $(this).closest('li').remove();
    });

    $('#js-uploadify').uploadify({
        buttonText: '浏览并上传',
        buttonClass: 'btn-info',
        swf: '/static/back-assets/dist/uploadify/uploadify.swf',
        uploader: '/petfarm/petfarm/picadd/upload/',
        fileTypeExts: '*.jpg;*.jpeg;*.gif;*.png;*.bmp;',
        fileSizeLimit: '4MB',
        multi: 'false',
        formData: {},
        onUploadError: function(file, errorCode, errorMsg, errorString){
            if(errorMsg == "500"){
                errorString = '服务器内部错误';
            }

            alert('"' + file.name + '" 上传失败：' + errorString + '，请重试！');
        },
        onUploadSuccess: function(file, data, response){
            if (!response) {
                alert('请求超时，请稍后重试！');
                return;
            }

            data = $.parseJSON(data);
            actualSize = [data.width, data.height];

            $cropModal.modal('show').addClass('loading');
            loadImage(data.url, function(){
                index++;
                afterUploadSuccess(data);
            });
        }
    });


    //form submit
    var $form = $('#js-form');

    $form.on('submit', function(){
        console.log($form.serializeArray())
        var data = {
            "img-count": index
        };

        $.each($form.serializeArray(), function(i, e){
            data[e.name] = e.value;
        });

        console.log(data)
        return false;
    });


})(jQuery);

</script>
{% endblock %}