{% extends 'manager/tpl/base/base.html' %}

{% block title %}内容编辑{% endblock %}
{% load assets_manager %}

{% block css %}
<link rel="stylesheet" href="{{ 'lib/jstree/style.css'|assets_manager }}"/>
{% endblock %}

{% block main %}
<h1 class="page-header">地址编辑</h1>

<div id="address-tree"></div>

{% endblock %}

{% block scripts %}
<script src="{{ 'lib/jstree/jstree.js'|assets_manager }}"></script>
<script>
(function(){


var $tree = $('#address-tree').jstree({
    'core': {
        'check_callback': function(operation, node, node_parent, node_position){
            if(operation == 'delete_node'){
                var parents = node.parents,
                    original = node.original,
                    len = parents.length - 1,
                    data = {};

                data[original.type] = original.index;
                for(var i = 0; i < len; i++){
                    var node = $tree.get_node(parents[i]).original;
                    data[node.type] = node.index;
                }

                data.del = true;
                ajax(data);
            }
        },
        'data': {
            'url': './',
            'dataType': 'json',
            'data': function(node){
                var original = node.original,
                    data = {};

                if(original){
                    data = paramMap(original, node.parents);
                }else{
                    data.ranges = 'ranges';
                }

                return data;
            }
        }
    },
    'plugins' : [ 'contextmenu' ]
}).jstree(true);

function ajax(data){
    $.ajax({
        url: './',
        dataType: 'json',
        data: data,
        success: function(data){
            console.log(data);
        }
    });
}


function paramMap(original, parents){
    var data = {},
        len = parents.length - 1,
        type = original.type;

    data[type] = original.index;

    for(var i = 0; i < len; i++){
        var node = $tree.get_node(parents[i]).original;
        data[node.type] = node.index;
    }

    switch (type){
        case 'range':
            data.provinces = 'provinces';
            break;
        case 'province':
            data.citys = 'citys';
            break;
        case 'city':
            data.disticts = 'disticts';
            break;
        case 'distict':
            data.streets = 'streets';
            break;
    }

    return data;
}

})();
</script>
{% endblock %}